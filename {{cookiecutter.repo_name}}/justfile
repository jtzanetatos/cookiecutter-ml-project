# justfile

# -----------------------------------------------------------------------------
# Configuration
# -----------------------------------------------------------------------------
# Use bash and strict mode (commands fail immediately on error)
set shell := ["bash", "-uc"]

# Load .env file automatically if it exists (great for API keys)
set dotenv-load

# -----------------------------------------------------------------------------
# UV Commands
# -----------------------------------------------------------------------------

# Lock dependencies
lock:
    uv lock

# -----------------------------------------------------------------------------
# Recipes
# -----------------------------------------------------------------------------

# List available commands
default:
    @just --list

# -----------------------------------------------------------------------------
# Setup & Maintenance
# -----------------------------------------------------------------------------

# Install dependencies, pull data, and setup hooks
setup:
    @echo "Installing python dependencies..."
    @echo "Installing python dependencies..."
    # uv sync creates the venv and installs deps
    uv sync
    # Install the project itself in editable mode (uv sync does this if configured, but ensuring explicit install if needed)
    # uv pip install -e .
    @echo "Pulling data from DVC..."
    dvc pull
    @echo "Installing pre-commit hooks..."
    pre-commit install
    @echo "Setup complete! Ready to train."

# Update dependencies from pyproject.toml
update:
# Update dependencies (re-lock and sync)
update:
    uv lock --upgrade
    uv sync

# Clean up cache, build artifacts, and pycache
clean:
    rm -rf dist/ build/ .pytest_cache/ .mypy_cache/
    find . -type d -name "__pycache__" -exec rm -rf {} +
    @echo "Cleaned up."

# -----------------------------------------------------------------------------
# Quality Control
# -----------------------------------------------------------------------------

# Run all checks (lint + format + test)
check: lint format test

# Run ruff linter
lint:
    ruff check src tests

# Run code formatting
format:
    ruff format src tests

# Run static type checking
type-check:
    mypy src

# Run tests
test:
    pytest tests/

# -----------------------------------------------------------------------------
# MLOps & Training
# -----------------------------------------------------------------------------

# Run training. Usage: just train experiment=baseline model.lr=0.01
# The '+' allows passing arbitrary arguments to hydra
train +hydra_args:
    python src/{{ cookiecutter.project_slug }}/cli/train.py {{ '{{' }} hydra_args {{ '}}' }}

# Run a hyperparameter sweep (Optuna)
sweep:
    python src/train.py -m hydra/sweeper=optuna

# Start the MLFlow UI
mlflow:
    mlflow ui