# justfile

# -----------------------------------------------------------------------------
# Configuration
# -----------------------------------------------------------------------------
# Use bash and strict mode (commands fail immediately on error)
set shell := ["bash", "-uc"]

# Load .env file automatically if it exists (great for API keys)
set dotenv-load

# -----------------------------------------------------------------------------
# UV Commands
# -----------------------------------------------------------------------------

# Lock dependencies
lock:
    uv lock

# -----------------------------------------------------------------------------
# Recipes
# -----------------------------------------------------------------------------

# List available commands
default:
    @just --list

# -----------------------------------------------------------------------------
# Setup & Maintenance
# -----------------------------------------------------------------------------

# Install dependencies, pull data, and setup hooks
# Install dependencies, pull data, and setup hooks
setup:
    @echo "Installing python dependencies..."
    # uv sync creates the venv and installs deps (including editable install of project)
    uv sync
    @echo "Pulling data from DVC..."
    dvc pull
    @echo "Installing pre-commit hooks..."
    pre-commit install
    @echo "Configuring notebook filters..."
    sh tools/setup_notebooks.sh
    @echo "Setup complete! Ready to train."

# Update dependencies from pyproject.toml
update:
    uv lock --upgrade
    uv sync

# Clean up cache, build artifacts, and pycache
clean:
    rm -rf dist/ build/ .pytest_cache/ .mypy_cache/
    find . -type d -name "__pycache__" -exec rm -rf {} +
    @echo "Cleaned up."

# -----------------------------------------------------------------------------
# Quality Control
# -----------------------------------------------------------------------------

# Run all checks (lint + format + test)
check: lint format test

# Run ruff linter
lint:
    uv run ruff check src tests

# Run code formatting
format:
    uv run ruff format src tests

# Run static type checking
type-check:
    uv run mypy src

# Run tests
test:
    uv run pytest tests/

# -----------------------------------------------------------------------------
# MLOps & Training
# -----------------------------------------------------------------------------

# Run training. Usage: just train experiment=baseline model.lr=0.01
# The '+' allows passing arbitrary arguments to hydra
train +hydra_args:
    uv run python -m {{ cookiecutter.project_slug }}.cli.train {{ '{{' }} hydra_args {{ '}}' }}

# Run a hyperparameter sweep (Optuna)
sweep:
    uv run python -m {{ cookiecutter.project_slug }}.cli.train -m hydra/sweeper=optuna

# Start the MLFlow UI
mlflow:
    uv run mlflow ui

# -----------------------------------------------------------------------------
# Docker & Deployment
# -----------------------------------------------------------------------------

# Build the API server Docker image
docker-build:
    docker build -t {{ cookiecutter.project_slug }}:latest -f deployment/docker/Dockerfile .

# Run the API server container (locally)
docker-run:
    docker run --rm -p 8000:8000 --env-file .env {{ cookiecutter.project_slug }}:latest

# -----------------------------------------------------------------------------
# Release
# -----------------------------------------------------------------------------

# Create a new release (tag + push)
release version part="patch":
    uv run python tools/release.py --part {{ '{{' }} part {{ '}}' }}