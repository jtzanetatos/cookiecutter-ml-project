name: Cookiecutter Smoke Test

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7.2.0
        with:
          python-version: "3.12"
          enable-cache: true

      - name: Install cookiecutter
        run: |
          uv tool install cookiecutter

      - name: Generate project (no-input)
        run: |
          out_dir="${{ runner.temp }}/cc-out"
          mkdir -p "$out_dir"

          cookiecutter . --no-input -o "$out_dir" \
            repo_name=test-ml \
            project_slug=test_ml_project \
            owner=acme \
            project_title="Test ML Project" \
            hydra_args=""

          test -d "$out_dir/test-ml"
          echo "OUT_DIR=$out_dir" >> "$GITHUB_ENV"

      - name: Assert placeholders are rendered
        run: |
          cd "$OUT_DIR/test-ml"

          # No cookiecutter placeholders should remain in generated repo
          if grep -RIn --exclude-dir=.git "{{cookiecutter" .; then
            echo "ERROR: Unrendered cookiecutter placeholders found."
            exit 1
          fi

      - name: Basic structure checks
        run: |
          cd "$OUT_DIR/test-ml"
          test -f pyproject.toml
          test -d config
          test -d deployment
          test -d tests
          test -d tools
          test -d "src/test_ml_project"

      - name: Python syntax check (no deps)
        run: |
          cd "$OUT_DIR/test-ml"
          python -m compileall -q src
